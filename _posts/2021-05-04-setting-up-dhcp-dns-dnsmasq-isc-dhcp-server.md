---
layout: post
title: Налаштування dhcp та dns з допомогою dnsmasq та isc-dhcp-server
date: 2021-05-04
categories: DevOps Networks Linux
---

Моя перша стаття з циклу дописів про Linux і мережі для DevOps чи системного адміністратора. У цьому циклі постараюсь трохи розповісти про мережі, як їх налаштовувати, а саме буду давати розв'язки на конкретні задачі, які мені задавали при підготовці на курсах по DevOps. І одна з цих задач була налаштувати DHCP та DNS на віртуальній машині. Як це зробити і умова задачі нижче. Тому ласкаво прошу під кат...

# Задача

Припустимо у нас є три віртуальні машини VirtualBox. VM1 має два мережевих адаптери: перший NAT, другий Internal. VM2 та VM3 мають тільки Internal. Наша задача підняти dhcp сервер на VM1 та автоматично роздавати IP на VM2 та VM3. А також підняти dns для доступу у інтернет.

# Теорія

**DHCP** (Dynamic Host Configuration Protocol) — це стандартний протокол прикладного рівня (7 рівень системи OSI), який дозволяє комп'ютерам автоматично отримувати IP-адресу та інші параметри, необхідні для роботи в мережі.

**DNS** (Domain Name System) або система доменних імен - ієрархічна система серверів, що дозволяє перетворити IP адресу комп'ютера чи будь-якого іншого пристрою у мережі у зручну для людини форму.

**DNSMASQ** - це легкий dhcp та dns сервер, який створений для невеликих мереж (до 1000 клієнтів) і може бути використаний на роутерах чи system-on-a-chip пристроях. Також забезпечує іменами локальні машини, які не мають глобальних DNS-записів.

**Masquerading** - підміна частин заголовка IP-пакета, яка дозволяє машинам без реальної IP-адреси виходити у інтенет.

# Практика

### DNSMASQ

Дана задача виконується на "ванільному" Ubuntu server 16.04, тому всі дії будуть актальні для цієї ситеми, хоч і не виключено, що також працюватимуть і у інших дистрибутивах.

1.  Встановимо dnsmasq на VM1

	`sudo apt update && sudo apt install dnsmasq`

2.  Можемо перевірити чи сервер запущений і працює командою:

	`systemctl status dnsmasq` або `ps aux | grep dnsmasq`

3. Спершу внесемо мережевий інтефейс на якому буде працювати dnsmasq та діапазон адресів, які можуть бути призначені

	`sudo vim /etc/dnsmasq.conf`

    І налаштовуємо, як на картинці нижче або, як потрібно вам.

    ```
    interface=enp0s8
    ```

    Тобто беремо другий інтерфейс або той, що "дивиться" у локальну мереж (бо ж перший це у нас NAT).

    	![dnsmasq-2021-05-05-1.png]({{ site.baseurl }}/20210504/images/dnsmasq-2021-05-04-1.png)

    Тепер додамо діапазон адресів. У моєму випадку  це мережа 10.10.10.0, тому вносимо:

    ```
    dhcp-range=10.10.10.10,10.10.10.20,12h
    ```

    *10.10.10.10* - початова адреса з діапазону адресів, які будуть видаватися
    *10.10.10.20* - кінцева адреса з діапазону адресів, які будуть видаватися
    *12h* - так званий lease time або час дії ліцензії на адресу, тобто через який час dhcp сервер перестане асоціювати хост з IP-адресою.

	![dnsmasq-2021-05-05-2.png]({{ site.baseurl }}/20210504/images/dnsmasq-2021-05-04-2.png)

    Все, dnsmasq налаштований.
    Можемо перевірити чи ми нігде не зафакапили налаштування командою `dnsmasq --test`

4. Тепер візьмемось за налаштування мережевих інтерфейсів у віртуальних машинах. І почнемо з VM1.

    Спершу виконаємо `sudo ifdown enp0s8` для того аби відключити весь мережевий трафік на інтерфейсі і мати можливість його налаштувати.

    Далі:

    `sudo vim /etc/network/interfaces`

    І налаштовуємо, як на картинці нижче.

    ![net-int-vm1-2021-05-04]({{ site.baseurl }}/images/20210504/net-int-vm1-2021-05-04.png)

    **enp0s3** не чіпаємо - він є NAT адаптером згідно умов задачі і має динамічну адресу, тому тут все ОК.

    А ось **enp0s8** налаштовуємо на статику:

    ```
    auto enp0s8
    iface enp0s8 inet static
    address 10.10.10.1
    netmask 255.255.255.0
    ```
    
    *inet static* - інтерфейс отримує статичну IP-адресу
    *address 10.10.10.1* - конкретно прописуємо, яку IP-адресу надати
    *netmask 255.255.255.0* - маска мережі, в даному випадку буде мінятись тільки останній октет

    Не забуваємо підняти наш мережевий інтерфейс командою `sudo ifup enp0s8`
    Та перезвантажити сервіси `sudo systemctl restart dnsmasq.service networking.service`

    Налаштування VM1 завершено.

5. Налаштуємо VM2 і VM3. Одразу скажу, що їхні налаштування будуть абсолютно однакові, тому приклади будуть тільки для VM2.

    Схема схожа до налаштвання VM1, тому спершу виконуємо `sudo ifdown enp0s8`

    Далі редагуємо конфіг "interfaces":

    `sudo vim /etc/network/interfaces`

    Налаштовуємо, як на картинці нижче:

    ![net-int-vm2-vm3-2021-05-04]({{ site.baseurl }}/images/20210504/net-int-vm2-vm3-2021-05-04.png)

    ```
    auto enp0s3
    iface enp0s3 inet dhcp
    ```

    *inet dhcp* - даємо інтерфейсу динамічну IP-адресу

    Виконуємо `sudo ifup enp0s8` та на всякий пожежний `sudo systemctl restart networking.service`
    Все, наші машинки налаштовані!

6. Залишилось перевірити, які IP-адреси отримали наші машинки. Зробити це можна командою `ip a` або `ifconfig`

    Я буду використовувати `ip a` і виконаю її на усіх віртуалках.

    VM1:

    ![ip-a-vm1]({{ site.baseurl }}/images/20210504/ip-a-vm1.png)

    VM2:

    ![ip-a-vm2]({{ site.baseurl }}/images/20210504/ip-a-vm2.png)

    VM3:

    ![ip-a-vm3]({{ site.baseurl }}/images/20210504/ip-a-vm3.png)

    Готово! Як бачите dnsmasq працює і наші машинки VM2 та VM3 успішно отримали ip-адреси 10.10.10.19 та 10.10.10.13 відповідно.

7. Зверніть увагу, що наші машинки бачать тільки свою мережу і відповідно пінгувати можуть тільки всередині 10.10.10.0, тобто між собою. Для того, щоб це виправити, потрібно прописати правило *iptables* і зробити masquerading

    `sudo iptables -t nat -A POSTROUTING -o enp0s3 - j MASQUERADE`

    Тепер `ping 8.8.8.8` VM2 чи VM3 буде успішний.

### ISC-DHCP-SERVER

